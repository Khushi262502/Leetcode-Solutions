from collections import defaultdict

class Solution(object):
    def pyramidTransition(self, bottom, allowed):
        mp = defaultdict(list)
        for a, b, c in allowed:
            mp[a + b].append(c)

        memo = {}

        def dfs(row):
            if row in memo:
                return memo[row]
            if len(row) == 1:
                return True

            def backtrack(i, path):
                if i == len(row) - 1:
                    return [path]
                pair = row[i] + row[i + 1]
                res = []
                if pair in mp:
                    for ch in mp[pair]:
                        res.extend(backtrack(i + 1, path + ch))
                return res

            for nr in backtrack(0, ""):
                if dfs(nr):
                    memo[row] = True
                    return True

            memo[row] = False
            return False

        return dfs(bottom)
